<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Голосование</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #fafafa;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: #1a1a1a;
    }

    .header {
      text-align: center;
      margin-bottom: 32px;
    }

    .cta {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 16px;
      color: #1a1a1a;
    }

    .cta.voted {
      color: #43a047;
    }

    .cta.closed {
      color: #999;
    }

    .round-info {
      font-size: 1rem;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-weight: 500;
    }

    .round-name {
      font-size: 1.2rem;
      margin-top: 8px;
      color: #1a1a1a;
      font-weight: 600;
    }

    .round-name:empty {
      display: none;
    }

    .voting-container {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      width: 100%;
      max-width: 800px;
      justify-content: center;
    }

    .team-btn {
      flex: 1 1 calc(50% - 16px);
      min-width: 200px;
      max-width: 300px;
      padding: 40px 20px;
      border: 3px solid #1a1a1a;
      border-radius: 16px;
      font-size: 1.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      background: #fff;
      color: #1a1a1a;
    }

    .team-btn:hover:not(:disabled) {
      color: #fff;
      transform: scale(1.02);
    }

    .team-btn:active:not(:disabled) {
      transform: scale(0.98);
    }

    .team-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .team-btn.selected {
      color: #fff;
    }

    .vote-count {
      font-size: 3rem;
      font-weight: 700;
      line-height: 1;
    }

    .team-name {
      font-size: 1rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-align: center;
    }

    .confirm-section {
      margin-top: 32px;
      text-align: center;
    }

    .confirm-btn {
      padding: 16px 48px;
      font-size: 1.2rem;
      font-weight: 600;
      border: 3px solid #43a047;
      border-radius: 12px;
      background: #43a047;
      color: #fff;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .confirm-btn:hover {
      background: #388e3c;
      border-color: #388e3c;
      transform: scale(1.02);
    }

    .confirm-btn:active {
      transform: scale(0.98);
    }

    .confirm-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .confirm-btn.hidden {
      display: none;
    }

    .selected-team-name {
      margin-bottom: 12px;
      font-size: 1rem;
      color: #666;
    }

    .total-voters {
      margin-top: 24px;
      color: #999;
      font-size: 0.85rem;
    }

    @media (max-width: 480px) {
      .team-btn {
        flex: 1 1 100%;
        max-width: none;
        padding: 30px 20px;
      }

      .vote-count {
        font-size: 2.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="cta" id="cta">Голосуй за лучшую команду!</div>
    <div class="round-info">Раунд <span id="round">1</span></div>
    <div class="round-name" id="round-name"></div>
  </div>

  <div class="voting-container" id="voting-container">
    <!-- Teams will be rendered here -->
  </div>

  <div class="confirm-section" id="confirm-section">
    <div class="selected-team-name" id="selected-team-name"></div>
    <button class="confirm-btn hidden" id="confirm-btn" onclick="confirmVote()">
      Подтвердить
    </button>
  </div>

  <div class="total-voters" id="total-voters"></div>

  <!-- FingerprintJS for device identification -->
  <script src="https://cdn.jsdelivr.net/npm/@aspect-security/fingerprint-js@3.4.2/dist/fingerprint.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    let teams = [];
    let votedFor = null;        // Confirmed vote
    let selectedTeam = null;    // Pre-selected (not confirmed yet)
    let votingOpen = true;
    let visitorId = null;
    let visitorKey = null;

    // Generate device fingerprint
    async function getFingerprint() {
      try {
        // Try localStorage first (persists across sessions)
        const stored = localStorage.getItem('voter_fingerprint');
        if (stored) {
          const data = JSON.parse(stored);
          visitorId = data.visitorId;
          visitorKey = data.visitorKey;
          return;
        }
      } catch (e) {}

      // Generate new fingerprint based on device characteristics
      const components = [
        navigator.userAgent,
        navigator.language,
        screen.width + 'x' + screen.height,
        screen.colorDepth,
        new Date().getTimezoneOffset(),
        navigator.hardwareConcurrency || 'unknown',
        navigator.platform,
        // Canvas fingerprint
        await getCanvasFingerprint()
      ];

      // Create hash
      const fingerprint = components.join('|');
      visitorId = await hashString(fingerprint);
      visitorKey = await hashString(fingerprint + Date.now() + Math.random());

      // Store in localStorage
      try {
        localStorage.setItem('voter_fingerprint', JSON.stringify({ visitorId, visitorKey }));
      } catch (e) {}
    }

    function getCanvasFingerprint() {
      return new Promise(resolve => {
        try {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = 200;
          canvas.height = 50;

          ctx.textBaseline = 'top';
          ctx.font = '14px Arial';
          ctx.fillStyle = '#f60';
          ctx.fillRect(125, 1, 62, 20);
          ctx.fillStyle = '#069';
          ctx.fillText('Fingerprint', 2, 15);
          ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
          ctx.fillText('Fingerprint', 4, 17);

          resolve(canvas.toDataURL());
        } catch (e) {
          resolve('canvas-not-supported');
        }
      });
    }

    async function hashString(str) {
      const encoder = new TextEncoder();
      const data = encoder.encode(str);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Initialize
    async function init() {
      await getFingerprint();

      // Check if voted in localStorage
      const localVote = localStorage.getItem('current_vote');
      if (localVote) {
        try {
          const voteData = JSON.parse(localVote);
          if (voteData.visitorId === visitorId) {
            votedFor = voteData.teamId;
          }
        } catch (e) {}
      }

      // Register with server
      socket.emit('register-fingerprint', { visitorId, visitorKey });
    }

    init();

    function renderTeams() {
      const container = document.getElementById('voting-container');
      const isSelected = (id) => votedFor === id || selectedTeam === id;

      container.innerHTML = teams.map(team => `
        <button
          class="team-btn ${isSelected(team.id) ? 'selected' : ''}"
          style="border-color: ${team.color}; ${isSelected(team.id) ? `background: ${team.color}` : ''}"
          data-id="${team.id}"
          data-color="${team.color}"
          ${votedFor !== null || !votingOpen ? 'disabled' : ''}
          onclick="selectTeam(${team.id})"
        >
          <span class="team-name">${team.name}</span>
          <span class="vote-count">${team.votes}</span>
        </button>
      `).join('');

      // Add hover effects
      container.querySelectorAll('.team-btn:not(:disabled)').forEach(btn => {
        const color = btn.dataset.color;
        btn.addEventListener('mouseenter', () => {
          if (!btn.classList.contains('selected')) {
            btn.style.background = color;
          }
        });
        btn.addEventListener('mouseleave', () => {
          if (!btn.classList.contains('selected')) {
            btn.style.background = '#fff';
          }
        });
      });

      // Update confirm button
      updateConfirmButton();
    }

    function updateConfirmButton() {
      const confirmBtn = document.getElementById('confirm-btn');
      const selectedName = document.getElementById('selected-team-name');

      if (votedFor !== null) {
        // Already voted
        confirmBtn.classList.add('hidden');
        selectedName.textContent = '';
      } else if (selectedTeam !== null && votingOpen) {
        // Team selected, show confirm
        const team = teams.find(t => t.id === selectedTeam);
        if (team) {
          selectedName.textContent = `Вы выбрали: ${team.name}`;
          confirmBtn.classList.remove('hidden');
        }
      } else {
        // Nothing selected
        confirmBtn.classList.add('hidden');
        selectedName.textContent = '';
      }
    }

    function selectTeam(teamId) {
      if (votedFor !== null || !votingOpen) return;
      selectedTeam = teamId;
      renderTeams();
    }

    function confirmVote() {
      if (selectedTeam === null || votedFor !== null || !votingOpen) return;
      socket.emit('vote', { teamId: selectedTeam, visitorId, visitorKey });
    }

    function updateStatus() {
      const cta = document.getElementById('cta');
      cta.classList.remove('voted', 'closed');

      if (!votingOpen) {
        cta.classList.add('closed');
        cta.textContent = 'Голосование закрыто';
      } else if (votedFor !== null) {
        cta.classList.add('voted');
        cta.textContent = 'Спасибо за голос!';
      } else {
        cta.textContent = 'Голосуй за лучшую команду!';
      }
    }

    socket.on('state', (data) => {
      document.getElementById('round').textContent = data.round;
      document.getElementById('round-name').textContent = data.roundName || '';
      teams = data.teams;
      votingOpen = data.votingOpen;

      // Server says we voted - trust it
      if (data.votedFor !== null) {
        votedFor = data.votedFor;
        // Update localStorage
        try {
          localStorage.setItem('current_vote', JSON.stringify({ visitorId, teamId: votedFor }));
        } catch (e) {}
      }

      renderTeams();
      updateStatus();
    });

    socket.on('results', (data) => {
      teams = data.teams;
      document.getElementById('total-voters').textContent = `${data.totalVoters} голосов`;
      renderTeams();
    });

    socket.on('voted', (teamId) => {
      votedFor = teamId;
      // Store in localStorage
      try {
        localStorage.setItem('current_vote', JSON.stringify({ visitorId, teamId }));
      } catch (e) {}
      renderTeams();
      updateStatus();
    });

    socket.on('reset', (data) => {
      document.getElementById('round').textContent = data.round;
      document.getElementById('round-name').textContent = data.roundName || '';
      teams = data.teams;
      votedFor = null;
      votingOpen = data.votingOpen;
      document.getElementById('total-voters').textContent = '';
      // Clear localStorage vote
      try {
        localStorage.removeItem('current_vote');
      } catch (e) {}
      renderTeams();
      updateStatus();
    });

    socket.on('new-round', (data) => {
      document.getElementById('round').textContent = data.round;
      document.getElementById('round-name').textContent = data.roundName || '';
      teams = data.teams;
      votedFor = null;
      votingOpen = data.votingOpen;
      document.getElementById('total-voters').textContent = '';
      // Clear localStorage vote
      try {
        localStorage.removeItem('current_vote');
      } catch (e) {}
      renderTeams();
      updateStatus();
    });

    socket.on('voting-status', (data) => {
      votingOpen = data.votingOpen;
      renderTeams();
      updateStatus();
    });

    socket.on('round-name-updated', (data) => {
      document.getElementById('round-name').textContent = data.roundName || '';
    });

    socket.on('teams-updated', (data) => {
      teams = data.teams;
      renderTeams();
    });

    socket.on('error', (msg) => {
      // Don't show alert for "already voted" - just update UI
      if (msg.includes('уже голосовали')) {
        updateStatus();
      } else {
        alert(msg);
      }
    });

    function vote(teamId) {
      if (votedFor !== null || !votingOpen) return;
      socket.emit('vote', { teamId, visitorId, visitorKey });
    }
  </script>
</body>
</html>
